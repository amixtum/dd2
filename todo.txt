Test Harness
Refactor newrunstate match bodies into functions